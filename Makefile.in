all:
	$(MAKE) qtclients @OMSHELL_TERMINAL@

autoconfGeneratedFiles = @GENERATED_AUTOCONF_FILES@

abs_top_builddir=@abs_top_builddir@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
includedir = @includedir@
datadir = @datadir@
datarootdir = @datarootdir@
docdir = @docdir@
CMAKE = CC="$(CC)" CXX="$(CXX)" CFLAGS="$(CFLAGS)" CPPFLAGS="$(CPPFLAGS)" cmake
CMAKE_RPATH = CC="$(CC)" CXX="$(CXX)" CFLAGS="$(CFLAGS)" CXXFLAGS="$(CXXFLAGS)" CPPFLAGS="$(CPPFLAGS)" LDFLAGS="@RPATH_QMAKE@" cmake
CMAKE_TARGET = "Unix Makefiles"
OPENCL = @OPENCL@
AR = @AR@
host = @host@
FC = @FC@

defaultMakefileTarget = Makefile
MAKEFILE_BOOT = LinkMain.makefile
QMAKE=@QMAKE@
APP=@APP@

CC=@CC@
CXX=@CXX@
CFLAGS=@CFLAGS@
MSGPACK_CFLAGS =
CPPFLAGS=@CPPFLAGS@
CXXFLAGS=@CXXFLAGS@
LDFLAGS=@LDFLAGS@
LINK=@LINK@
MSL_EXTRA_ARGS=@MSL_EXTRA_ARGS@
# LIBGC configuration is different for Linux (this file) and Windows (Makefile.omdev.mingw)
# Do not use munmap; it crashes processes...
LIBGC_EXTRA_CONFIGURATION=--enable-threads=posix --enable-parallel-mark
LIBFMILIB=@LIBFMILIB@
LIBCMINPACKLIB=@LIBCMINPACKLIB@
LD_LAPACK=@LD_LAPACK@
LAPACK_TARGET=@LAPACK_TARGET@
OPENBLAS_EXTRA_ARGS=@OPENBLAS_EXTRA_ARGS@
IPOPT_TARGET=ipopt
UMFPACK_TARGET=@UMFPACK_TARGET@
# We don't want the shared version, but symbols are not exported if we use the static version
# This compiles the shared and static versions, but we only copy the static version...
FMILIB_SHARED = @FMILIB_SHARED@
CMINPACKLIB_SHARED = @CMINPACKLIB_SHARED@
MODELICA_SPEC_PLATFORM=@MODELICA_SPEC_PLATFORM@
SHREXT = @SHREXT@

include Makefile.common

# We don't need OMDEV hacks, but using the same Makefile sure is nice!
.testvariables:
settings:

omc: omc-bootstrapped

boehm-gc-lib: @LIBGC@
build/lib/omc/libgc.so: 3rdParty/gc/.libs/libgc.so
	mkdir -p build/lib/omc/
	cp -pPR $< $<.* build/lib/omc/
3rdParty/gc/.libs/libgc.so: 3rdParty/gc/Makefile
	$(MAKE) -C 3rdParty/gc/

qtclean-common:
	rm -rf OMShell/bin/OMShell$(EXE) OMShell/OMShellGUI/omc_communication.*
	rm -rf OMNotebook/bin/OMNotebook$(EXE) OMNotebook/OMNotebookGUI/omc_communication.*
	rm -rf OMOptim/build/OMOptim$(EXE) OMOptim/build/omc_communication.*
	for f in 3rdParty/qwt \
	         OMEdit/OMEditGUI \
	         OMNotebook/OMNotebookGUI \
	         OMOptim/build \
	         OMOptimBasis/build \
	         OMShell/OMShellGUI \
	         OMPlot/OMPlotGUI \
	         ; do test ! -f $$f/Makefile || (make -C $$f clean && rm -f $$f/Makefile); done
ifeq ($(QMAKE),)
qtclients:
	@echo "*** OpenModelica configured without support for Qt"
qtclean: qtclean-common
else ifeq (@IDLCMD@,)
qtclients: omedit
	@echo "*** OpenModelica configured without support for CORBA"
qtclean: qtclean-common
else
qwt-build:
	$(MAKE) -C 3rdParty/qwt -f Makefile.unix
build/lib/omc/libomqwt.so: qwt-build
	cp -a 3rdParty/qwt/lib/libomqwt.so* build/lib/omc/
build/lib/omc/libomqwt.dylib: qwt-build
	cp -a 3rdParty/qwt/lib/libomqwt*dylib build/lib/omc/
	install_name_tool -id @rpath/libomqwt.6.2.0.dylib build/lib/omc/libomqwt.6.2.0.dylib

qwt: build/lib/omc/libomqwt@SHREXT@

omnotebook: mkbuilddirs qwt omplot
	mkdir -p $(builddir_share)/omnotebook
	$(MAKE) -C OMNotebook/OMNotebookGUI -f Makefile.unix
omshell: mkbuilddirs
	$(MAKE) -C OMShell/OMShellGUI -f Makefile.unix
omplot: mkbuilddirs qwt
	$(MAKE) -C OMPlot/OMPlotGUI -f Makefile.unix
omedit: omc qwt omplot qjson
	$(MAKE) -C OMEdit/OMEditGUI -f Makefile.unix
ifeq (@with_paradiseo@,)
omoptim:
	@echo "*** OpenModelica configured without support for OMOptim (--without-paradisEO)"
omoptimbasis:
	@echo "*** OpenModelica configured without support for OMOptim (--without-paradisEO)"
else
omoptim: mkbuilddirs qwt omoptimbasis
	$(MAKE) -C OMOptim/build -f Makefile.unix
omoptimbasis: mkbuilddirs qwt
	$(MAKE) -C OMOptimBasis/build -f Makefile.unix
endif

qtclients: qwt @OMNOTEBOOK@ omshell omedit omplot omoptim omoptimbasis

qtclean: qtclean-common
	$(MAKE) -C OMShell/OMShellGUI -f Makefile.unix clean
	$(MAKE) -C OMNotebook/OMNotebookGUI -f Makefile.unix clean
	$(MAKE) -C OMEdit/OMEditGUI -f Makefile.unix clean
	$(MAKE) -C OMPlot/OMPlotGUI -f Makefile.unix clean
	$(MAKE) -C OMOptim/build -f Makefile.unix clean
	$(MAKE) -C OMOptimBasis/build -f Makefile.unix clean
endif

omc-bootstrapped:
	$(MAKE) bootstrap-dependencies
	$(MAKE) -C Compiler/boot
	$(MAKE) omlibrary

modelica3d:
ifeq (@MODELICA3D@,)
	@echo Skipping Modelica3D
else
	cd 3rdParty/modelica3d && mkdir -p build
	cd 3rdParty/modelica3d/build && $(CMAKE_RPATH) -DCMAKE_COLOR_MAKEFILE:Bool=OFF -DOSG_BACKEND=1 -DUSE_OMC=0 ..
	$(MAKE) -C 3rdParty/modelica3d/build
	cp -p 3rdParty/modelica3d/build/backends/osg-gtk/libm3d-osg-gtk$(SHREXT) 3rdParty/modelica3d/build/lib/proc3d/libproc3d$(SHREXT) build/lib/
	test ! `uname` = Darwin || install_name_tool -id @rpath/libproc3d.dylib build/lib/libproc3d.dylib
	test ! `uname` = Darwin || install_name_tool -id @rpath/libm3d-osg-gtk.dylib build/lib/libm3d-osg-gtk.dylib
	test ! `uname` = Darwin || install_name_tool -change "`pwd`/3rdParty/modelica3d/build/lib/proc3d/libproc3d.dylib" "@rpath/libproc3d.dylib" build/lib/libm3d-osg-gtk.dylib
	cp -p 3rdParty/modelica3d/build/lib/modcount/libmodcount.a 3rdParty/modelica3d/build/lib/modbus/libmodbus.a build/lib/omc/
	mkdir -p build/lib/omlibrary-modelica3d/blender2.59 build/lib/omlibrary-modelica3d/osg-gtk/
	cp -p 3rdParty/modelica3d/examples/multibody/src/modelica/*.mo build/lib/omlibrary-modelica3d/
	cp -p 3rdParty/modelica3d/backends/blender2.59/dbus-server.py build/lib/omlibrary-modelica3d/blender2.59/
	cp -p 3rdParty/modelica3d/backends/osg-gtk/python/dbus-server.py build/lib/omlibrary-modelica3d/osg-gtk/
endif

lis: lis-configure mkbuilddirs
	@echo Building Lis from sources
	$(MAKE) -C 3rdParty/lis-1.4.12
	# Copy the library; not headers (as they are not used by the runtime system)
	cp -Pp 3rdParty/lis-1.4.12/src/.libs/liblis@SHREXT@* build/lib/omc/
	@# FreeBSD lis does not create the symlinks...
	! test -f build/lib/omc/liblis.so.0.0 -a ! -f build/lib/omc/liblis.so.0 || ln -s liblis.so.0.0 build/lib/omc/liblis.so.0
	! test -f build/lib/omc/liblis.so.0.0 -a ! -f build/lib/omc/liblis.so || ln -s liblis.so.0.0 build/lib/omc/liblis.so
lis-configure:
	# Configure and build lis
	if ! test -f 3rdParty/lis-1.4.12/Makefile; then cd 3rdParty/lis-1.4.12 && ./configure "--host=$(host)" --enable-shared --disable-static MPICC="false" CC="$(CC)" CXX="$(CXX)" CFLAGS="$(CFLAGS)" CPPFLAGS="$(CPPFLAGS)" LDFLAGS="$(LDFLAGS) @LIS_LDFLAGS@" && $(MAKE) clean; fi
lis-clean:
	if test -f 3rdParty/lis-1.4.12/Makefile; then $(MAKE) -C 3rdParty/lis-1.4.12 clean; fi
	rm -f 3rdParty/lis-1.4.12/Makefile

fix-svn-props:
	tools/apply_autoprops.py --config .svnprops .
fix-bom:
	find . -type f \( ! -path '*/.svn/*' -or -path '*/.git/*' -prune \) | while read file;do sed -i '1 s/^\xef\xbb\xbf//' "$$file";done

SOURCE_DIRS=$(SOURCE_DIRS_UTF8) "libraries/Modelica 2.2.2" testsuite/flattening/libraries/3rdParty/HumMod
SOURCE_DIRS_UTF8=OM*/ Compiler/ SimulationRuntime/ mosh/ `bash -c echo libraries/{BioChem 1.0,ModelicaAdditions,Modelica_LinearSystems2 2.3,Modelica 1.6,ModelicaServices 1.0,ModelicaServices 1.0 modelica3d,Modelica 3.1,SimpleFluid,Modelica 3.2.1,SimpleVisual.mo}` `bash -c echo testsuite/flattening/libraries/3rdParty/{PlanarMechanics,siemens,SiemensPower,ThermoSysPro}` testsuite/openmodelica/modelicaML testsuite/AVM testsuite/simulation

bom-error:
	rm -f bom-error.log bom-error.sh
	echo "#!/bin/sh\ntest \"\`head -c3 \\\"\$$1\\\"\`\" = \"\`/bin/echo -ne \"\\xef\\xbb\\xbf\"\`\" && (echo \$$1 contains BOM >> bom-error.log)" > bom-error.sh
	find $(SOURCE_DIRS) -type f \( ! -path '*/.svn/*' -or -path '*/.git/*' -prune \) \( ! -path 'libraries/Modelica 3.2.1/*' -prune \) -exec sh bom-error.sh "{}" ';'
	@if test -e bom-error.log; then cat bom-error.log; fi
	@test ! -e bom-error.log
	rm -f bom-error.log bom-error.sh

tab-error:
	! find $(SOURCE_DIRS) -regextype posix-egrep -regex '.*\.(cpp|c|h|mo|tpl)$$' -exec echo -n "{} " ';' -exec grep -c "	" '{}' ';' | \
          grep -v " 0\$$" | egrep -v '/GenTest/|/antlr-3.2/|Parser/MetaModelica_|Parser/ParModelica_|Parser/Modelica_3_|Parser/ModelicaParser'
# Trims trailing whitespace and replaces tabs with spaces
fix-whitespace:
	find . -type f \( ! -path '*/.svn/*' -or -path '*/.git/*' -prune \) -regextype posix-egrep -regex '.*\.(cpp|c|h|mo|tpl)$$' -exec sh -c 'sed -i -e "s/	/  /g" -e "s/ *\$$//" "{}"' ";"

spellcheck:
	grep -oE 'gettext[(]["]([^"]|([\\]["]))*["]' `ls Compiler/*/*.mo | grep -v Flags.mo` | sed "s/[\\%]./ /g" | aspell -p ./.openmodelica.aspell --mode=ccpp --lang=en_US list | sort -u | sed 's/^/aspell: /' | tee aspell.log
	@test ! -s aspell.log
thumbsdb-error:
	! find . -name "Thumbs.db" | grep Thumbs.db

utf8-error:
	rm -f utf8-error.log*
	find $(SOURCE_DIRS_UTF8) -regextype posix-egrep -regex '.*\.(cpp|c|h|mo|tpl)$$' -exec bash -c "iconv -f UTF-8 -t UTF-8 '{}' -o /dev/null 2>utf8-error.log2 || (echo -n '{}: ' && head -n1 utf8-error.log2)"  ';' 2>&1 > utf8-error.log
	# Also detect some valid UTF-8 that were obviously fracked up by Eclipse on Windows.
	find $(SOURCE_DIRS_UTF8) -regextype posix-egrep -regex '.*\.(cpp|c|h|mo|tpl)$$' -exec bash -c "grep 'Link[^A-Za-z0-9_,.;&-]*ping' '{}' | grep -v Linköping && (echo '{}: Failed Linköping test')"  ';' 2>&1 >> utf8-error.log
	@cat utf8-error.log
	@test ! -s utf8-error.log
	rm -f utf8-error.log*

utf8-iconv:
	rm -f tmp
	find $(SOURCE_DIRS) -regextype posix-egrep -regex '.*\.(cpp|c|h|mo|tpl)$$' -exec bash -c "iconv -f UTF-8 -t UTF-8 '{}' -o /dev/null 2>tmp || (rm -f tmp && cp '{}' tmp && iconv -f ISO-8859-1 -t UTF-8 tmp -o '{}' && echo Converted {} to UTF-8)" ';'
	rm -f tmp

.PRECIOUS: Makefile

Makefile: Makefile.in config.status
	$(top_builddir)/config.status

config.status: configure
	./config.status -recheck
configure: configure.in
	autoconf

emcc: msl-external-libs-emcc emcc-simulationruntime
emcc-simulationruntime:
	mkdir -p build/lib/omc/emcc/
	$(MAKE) -C SimulationRuntime/c emcc
