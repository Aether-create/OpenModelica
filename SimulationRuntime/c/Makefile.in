# Adrian Pop, adrpo@ida.liu.se, Martin Sj√∂lund, marsj@ida.liu.se
# - Use make -f Makefile.omdev.mingw if you want to compile on Windows/MinGW
# - Please leave the UNIX Makefile as it is if you are not using UNIX/Linux
# If you need to add files, etc, you modify Makefile.common - a common file
# for both UNIX/Linux and Windows platforms.

top_builddir = ../..
builddir_bin=$(top_builddir)/build/bin
builddir_lib=$(top_builddir)/build/lib/omc
builddir_inc=$(top_builddir)/build/include/omc

AR = @AR_SH@
CC = @CC@
CXX = @CXX@
CONFIG_CPPFLAGS = @CPPFLAGS@
CONFIG_CFLAGS = @CFLAGS@ @IPOPT_CFLAGS@
FPMATHFORTRAN = @FPMATHFORTRAN@
LDFLAGS=-L$(top_builddir)/build/lib/omc @RT_LDFLAGS@ 
LDFLAGS_SIM=-L$(top_builddir)/build/lib/omc -L../interactive @RT_LDFLAGS_SIM@

LIBMAKEFILE = Makefile
INTERACTIVELIBS = "-lpthread"
INTERACTIVECLIENT = ../interactive/SampleClient/interactiveclient@EXE@
QMAKE=@QMAKE@
CONFIG_H=$(top_builddir)/Compiler/runtime/config.h $(top_builddir)/Compiler/runtime/config.unix.h
# Use f2c from the OS itself... If so, don't include the f2c headers from OpenModelica
LIBF2C=@LIBF2C@
ifeq ($(LIBF2C),)
else
LIBF2CINC=-I./simulation/libf2c/
LIBF2CHEADER=./simulation/libf2c/f2c.h
endif
LIBSIMULATION=@LIBSIMULATION@
LIBRUNTIME=@LIBRUNTIME@
LIBFMIRUNTIME=@LIBFMIRUNTIME@
OBJ_EXT = .o

REGEN = Makefile.in

include Makefile.common

Makefile: Makefile.in
	cd $(top_builddir); ./config.status

expat.h:
	cp /usr/include/expat*.h .
emcc: Makefile emcc/pre.js emcc/liblapack.so emcc/libblas.so emcc/libexpat.so emcc/libSimulationRuntimeC.so emcc/libf2c.so emcc/mdpad/mdpad.html
	cp -a emcc/pre.js emcc/*.so emcc/mdpad $(builddir_lib)/emcc/
	@# emcc -Os --llvm-lto 2 -o $(builddir_lib)/emcc/libSimulationRuntimeC.js -s SIDE_MODULE=1 -s ASM_JS=1 -s TOTAL_MEMORY=536870912 -s OUTLINING_LIMIT=20000 libSimulationRuntimeC.bc simulation/libf2c/libf2c.bc emcc/liblapack.so emcc/libblas.so emcc/libexpat.so
emcc/liblapack.so:
	wget -O $@ https://github.com/tshort/openmodelica-javascript/blob/master/liblapack.so?raw=true || (rm -f $@ ; false)
emcc/libblas.so:
	wget  -O $@ https://github.com/tshort/openmodelica-javascript/blob/master/libblas.so?raw=true || (rm -f $@ ; false)
emcc/libexpat.so:
	wget  -O $@ https://github.com/tshort/openmodelica-javascript/blob/master/libexpat.so?raw=true || (rm -f $@ ; false)
emcc/libf2c.so:
	emmake $(MAKE) -C simulation/libf2c OBJ_EXT=.bc CC=emcc CXX=emcc CFLAGS="-Os" libf2c.bc
	cp simulation/libf2c/libf2c.bc emcc/libf2c.so
emcc/libSimulationRuntimeC.so: expat.h
	emmake $(MAKE) OBJ_EXT=.bc CC=emcc CXX=emcc CFLAGS=" $(CPPFLAGS) -Os -DOMC_EMCC -DNO_INTERACTIVE_DEPENDENCY -I./simulation/libf2c/" libSimulationRuntimeC.bc
	cp libSimulationRuntimeC.bc emcc/libSimulationRuntimeC.so
mdpad.tar.gz:
	wget -O mdpad.tar.gz https://github.com/sjoelund/mdpad/tarball/484fe6bfd592a0f549ce7269cab34fc793d0c1cb
emcc/mdpad/mdpad.html: mdpad.tar.gz
	tar xzf mdpad.tar.gz
	rm -rf emcc/mdpad
	mv sjoelund-mdpad-484fe6b emcc/mdpad
emcc-clean: Makefile
	$(MAKE) OBJ_EXT=.bc clean
	rm -f emcc/*.so mdpad.tar.gz
	rm -rf emcc/mdpad
